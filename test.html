<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SeaLink SDK æµ‹è¯•å¹³å°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
      font-size: 18px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
      font-size: 13px;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: monospace;
      transition: border-color 0.3s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .output {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .status {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
      margin-top: 10px;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status.warning {
      background: #fff3cd;
      color: #856404;
    }

    .messages {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .message {
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
      border-left: 3px solid;
    }

    .message.user {
      background: #e3f2fd;
      border-left-color: #2196f3;
    }

    .message.assistant {
      background: #f3e5f5;
      border-left-color: #9c27b0;
    }

    .message.streaming {
      background: #fff9e6;
      border-left-color: #ffc107;
    }

    .message-role {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      margin-bottom: 5px;
      opacity: 0.7;
    }

    .message-content {
      font-size: 14px;
      line-height: 1.5;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 11px;
      margin-right: 8px;
    }

    .config-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    code {
      background: #2d3748;
      color: #68d391;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸŒŠ SeaLink SDK æµ‹è¯•å¹³å°</h1>
      <p class="subtitle">
        <span class="badge">Core Transport</span>
        <span class="badge">Data PostgREST</span>
        <span class="badge">Runtime Conversations</span>
        <span class="badge">Chat WebSocket</span>
      </p>
    </header>

    <div class="grid">
      <!-- 1. Core Transport æµ‹è¯• -->
      <div class="card">
        <h2>ğŸ“¡ Core Transport</h2>
        <div class="config-section">
          <div class="form-group">
            <label>Base URL</label>
            <input type="text" id="transport-base-url" value="https://postgrest.sg.seaverse.dev" placeholder="https://postgrest.sg.seaverse.dev">
          </div>
          <div class="form-group">
            <label>Auth Token</label>
            <input type="text" id="transport-token" value="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjaG4iOiJzZWF2ZXJzZSIsInNjcCI6WyJsb2dpbiIsImFwaSIsImFjY291bnQiXSwicGF5bG9hZCI6eyJ1c2VyX2lkIjoiMUNXdEV3TG1rTDcza2dNWEt6WEJkSiIsInVzZXJuYW1lIjoiZGF0b3UiLCJlbWFpbCI6ImRhdG91QGhhaXlpLmFydCJ9LCJpc3MiOiJhdXRoLXNlcnZpY2UiLCJzdWIiOiIxQ1d0RXdMbWtMNzNrZ01YS3pYQmRKIiwiZXhwIjoxNzk5NTcyNDIzLCJuYmYiOjE3NjgwMzY0MjMsImlhdCI6MTc2ODAzNjQyMywianRpIjoiNzkxNDc2NDYtMWY2NS00Y2IxLWJkNmMtN2FjZTU0MjNjOTQxIn0.kXQ7X2M8EC6Ikvzpu_boZsLeNxNGROBGVQZX5qnwTQg" placeholder="your-auth-token">
          </div>
        </div>
        <button id="test-transport">æµ‹è¯• HTTP å®¢æˆ·ç«¯</button>
        <div id="transport-output" class="output"></div>
      </div>

      <!-- 2. PostgREST å®¢æˆ·ç«¯æµ‹è¯• -->
      <div class="card">
        <h2>ğŸ—„ï¸ Data PostgREST</h2>
        <div class="config-section">
          <div class="form-group">
            <label>Table Name</label>
            <input type="text" id="postgrest-table" value="conversations" placeholder="conversations">
          </div>
          <div class="form-group">
            <label>Filter (PostgREST format)</label>
            <input type="text" id="postgrest-filter" value="user_id=eq.1CWtEwLmkL73kgMXKzXBdJ" placeholder="user_id=eq.123">
          </div>
          <div class="form-group">
            <label>Order</label>
            <input type="text" id="postgrest-order" value="created_at.desc" placeholder="created_at.desc">
          </div>
          <div class="form-group">
            <label>Limit</label>
            <input type="number" id="postgrest-limit" value="10" min="1" max="100">
          </div>
        </div>
        <button id="test-postgrest">æŸ¥è¯¢æ•°æ®</button>
        <div id="postgrest-output" class="output"></div>
      </div>

      <!-- 3. Runtime Conversations æµ‹è¯• -->
      <div class="card full-width">
        <h2>ğŸ’¬ Runtime Conversations</h2>
        <div class="config-section">
          <div class="form-group">
            <label>Environment</label>
            <select id="conv-environment">
              <option value="dev" selected>dev</option>
              <option value="prod">prod</option>
            </select>
          </div>
          <div class="form-group">
            <label>Access Tokenï¼ˆé»˜è®¤å¤ç”¨ Core Transport çš„ Auth Tokenï¼‰</label>
            <input type="text" id="conv-access-token" value="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjaG4iOiJzZWF2ZXJzZSIsInNjcCI6WyJsb2dpbiIsImFwaSIsImFjY291bnQiXSwicGF5bG9hZCI6eyJ1c2VyX2lkIjoiMUNXdEV3TG1rTDcza2dNWEt6WEJkSiIsInVzZXJuYW1lIjoiZGF0b3UiLCJlbWFpbCI6ImRhdG91QGhhaXlpLmFydCJ9LCJpc3MiOiJhdXRoLXNlcnZpY2UiLCJzdWIiOiIxQ1d0RXdMbWtMNzNrZ01YS3pYQmRKIiwiZXhwIjoxNzk5NTcyNDIzLCJuYmYiOjE3NjgwMzY0MjMsImlhdCI6MTc2ODAzNjQyMywianRpIjoiNzkxNDc2NDYtMWY2NS00Y2IxLWJkNmMtN2FjZTU0MjNjOTQxIn0.kXQ7X2M8EC6Ikvzpu_boZsLeNxNGROBGVQZX5qnwTQg" placeholder="user-tokenï¼ˆå¯é€‰ï¼‰">
          </div>
          <div class="form-group">
            <label>App IDï¼ˆå¯é€‰ï¼Œç”¨äºèšåˆ/è¿‡æ»¤ï¼‰</label>
            <input type="text" id="conv-app-id" value="app-1769501930216-489ca672" placeholder="app-idï¼ˆå¯é€‰ï¼‰">
          </div>
          <div class="form-group">
            <label>User ID</label>
            <input type="text" id="conv-user-id" value="1CWtEwLmkL73kgMXKzXBdJ" placeholder="test-user-123">
          </div>
          <div class="form-group">
            <label>Pageï¼ˆåˆ†é¡µï¼Œä» 1 å¼€å§‹ï¼‰</label>
            <input type="number" id="conv-page" value="1" min="1" step="1">
          </div>
          <div class="form-group">
            <label>Page Sizeï¼ˆæ¯é¡µæ•°é‡ï¼‰</label>
            <input type="number" id="conv-page-size" value="1" min="1" max="100" step="1">
          </div>
          <div class="form-group">
            <label>æ“ä½œç±»å‹</label>
            <select id="conv-operation">
              <option value="list">è·å–ä¼šè¯åˆ—è¡¨</option>
              <option value="list-apps">è·å–åº”ç”¨å’Œä¼šè¯èšåˆæ•°æ®</option>
              <option value="messages">è·å–æ¶ˆæ¯åˆ—è¡¨</option>
              <option value="create">åˆ›å»ºä¼šè¯</option>
              <option value="delete">åˆ é™¤ä¼šè¯</option>
            </select>
          </div>
          <div class="form-group" id="conv-id-group" style="display:none;">
            <label>Conversation ID (ç”¨äºè·å–æ¶ˆæ¯/åˆ é™¤ä¼šè¯)</label>
            <input type="text" id="conv-conversation-id" value="49b2b48b-36f0-4079-ad8b-9fcdbf4371fa" placeholder="conversation-id">
          </div>
          <div class="form-group" id="conv-title-group" style="display:none;">
            <label>ä¼šè¯æ ‡é¢˜ (ç”¨äºåˆ›å»ºä¼šè¯)</label>
            <input type="text" id="conv-title" value="æµ‹è¯•ä¼šè¯" placeholder="æ–°ä¼šè¯æ ‡é¢˜">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button id="test-conversations">æ‰§è¡Œæ“ä½œ</button>
          <button id="test-url-session-token">è·å– URL Session Token</button>
        </div>
        <div id="conversations-output" class="output"></div>
      </div>

      <!-- 4. Chat WebSocket æµ‹è¯• -->
      <div class="card full-width">
        <h2>ğŸš€ Chat WebSocket</h2>
        <div class="config-section">
          <div class="form-group">
            <label>API URLï¼ˆå¿…å¡«ï¼Œé€šå¸¸ä¸æœåŠ¡åŒåŸŸï¼‰</label>
            <input type="text" id="chat-api-url" value="https://sandbox.sg.seaverse.ai/" placeholder="https://sandbox.sg.seaverse.ai/">
          </div>
          <div class="form-group">
            <label>Base URL</label>
            <input type="text" id="chat-base-url" value="https://sandbox.sg.seaverse.ai/" placeholder="https://sandbox.sg.seaverse.ai/">
          </div>
          <div class="form-group">
            <label>Token</label>
            <input type="text" id="chat-token" placeholder="your-websocket-token">
          </div>
          <div class="form-group">
            <label>Conversation ID</label>
            <input type="text" id="chat-conversation-id" placeholder="conversation-id">
          </div>
          <div class="form-group">
            <label>App ID</label>
            <input type="text" id="chat-app-id" placeholder="app-id">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button id="chat-connect">è¿æ¥ WebSocket</button>
          <button id="chat-disconnect" disabled>æ–­å¼€è¿æ¥</button>
        </div>
        <div id="chat-status"></div>

        <div style="margin-top: 20px;">
          <div class="form-group">
            <label>å‘é€æ¶ˆæ¯</label>
            <textarea id="chat-message" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..." rows="3"></textarea>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button id="chat-send" disabled>å‘é€æ¶ˆæ¯</button>
            <button id="chat-interrupt" disabled>ä¸­æ–­æ‰§è¡Œ</button>
          </div>
        </div>

        <div class="messages" id="chat-messages">
          <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
      </div>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "@seaverse/conversation-sdk": "./packages/conversation/dist/index.js",
        "@sealink/chat": "./packages/chat/dist/index.mjs"
      }
    }
  </script>

  <script type="module">
    // ============================================
    // çœŸå® SDK æµ‹è¯•é¡µé¢ï¼ˆæœ¬åœ° dist + importmapï¼‰
    // ============================================

    import { initConversationSdk } from '@seaverse/conversation-sdk';
    import { createChat } from '@sealink/chat';

    // è¾…åŠ©å‡½æ•°
    function log(elementId, message, type = 'info') {
      const output = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString();
      const typeEmoji = {
        info: 'ğŸ“˜',
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸'
      };
      const line = `[${timestamp}] ${typeEmoji[type]} ${message}`;
      output.textContent = `${line}\n\n${output.textContent}`;

      // åŒæ­¥è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä¾¿äºè‡ªåŠ¨åŒ–æµ‹è¯•/æ’æŸ¥ï¼ˆä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚
      const consoleFn =
        type === 'error' ? console.error :
        type === 'warning' ? console.warn :
        type === 'success' ? console.info :
        console.log;
      consoleFn(`[${elementId}] ${line}`);
    }

    function showStatus(elementId, message, type = 'info') {
      const container = document.getElementById(elementId);
      const statusDiv = document.createElement('div');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      container.textContent = '';
      container.appendChild(statusDiv);
    }

    function createMessageElement(role, content, isStreaming = false) {
      const msgDiv = document.createElement('div');
      msgDiv.className = isStreaming ? 'message streaming' : `message ${role}`;

      const roleDiv = document.createElement('div');
      roleDiv.className = 'message-role';
      roleDiv.textContent = isStreaming ? 'Assistant (Streaming...)' : role.charAt(0).toUpperCase() + role.slice(1);

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.textContent = content;

      msgDiv.appendChild(roleDiv);
      msgDiv.appendChild(contentDiv);

      return msgDiv;
    }

    function safeStringify(value) {
      try {
        return JSON.stringify(value, null, 2);
      } catch {
        return String(value);
      }
    }

    /**
     * è§£æ PostgREST filter è¾“å…¥
     * - æ”¯æŒ "a=eq.1&b=like.%25foo%25"
     * - æ”¯æŒå•æ¡ "a=eq.1"
     */
    function parsePostgrestFilter(filterText) {
      const text = (filterText || '').trim();
      if (!text) return undefined;

      const filter = {};
      const pairs = text.split('&').map(s => s.trim()).filter(Boolean);
      for (const pair of pairs) {
        const idx = pair.indexOf('=');
        if (idx <= 0) continue;
        const key = decodeURIComponent(pair.slice(0, idx));
        const value = decodeURIComponent(pair.slice(idx + 1));
        if (!key) continue;
        filter[key] = value;
      }
      return Object.keys(filter).length ? filter : undefined;
    }

    /**
     * åŒæºä»£ç† fetchï¼šæŠŠè·¨åŸŸè¯·æ±‚è½¬å‘åˆ°æœ¬åœ° `/_proxy?url=...`
     *
     * ç›®çš„ï¼šè§£å†³æµè§ˆå™¨ç›´æ¥è¯·æ±‚ seaverse åŸŸåçš„ CORS é™åˆ¶
     *
     * æ³¨æ„ï¼š
     * - ä»…ç”¨äºæœ¬åœ°æµ‹è¯•ï¼ˆä¾èµ– dev-server.mjsï¼‰
     * - ä¸ä¼šä¿®æ”¹è¯·æ±‚å¤´ï¼ŒAuthorization ä¼šéšè¯·æ±‚é€ä¼ åˆ° proxy
     */
    async function proxyFetch(input, init) {
      const url = typeof input === 'string' ? input : (input && input.url ? input.url : String(input));
      // åŒæºè¯·æ±‚ç›´æ¥èµ°åŸç”Ÿ fetch
      if (url.startsWith('/') || url.startsWith(window.location.origin)) {
        return fetch(input, init);
      }
      // ä»…ä»£ç† http/https
      if (!/^https?:\/\//i.test(url)) {
        return fetch(input, init);
      }
      const proxied = `/_proxy?url=${encodeURIComponent(url)}`;
      return fetch(proxied, init);
    }

    /**
     * å…¼å®¹è¾“å…¥ "Bearer xxx" æˆ– "xxx" ä¸¤ç§å½¢å¼
     */
    function normalizeAccessToken(raw) {
      const text = String(raw || '').trim();
      if (!text) return '';
      return text.replace(/^Bearer\s+/i, '').trim();
    }

    function getTransportInputs() {
      const baseUrl = document.getElementById('transport-base-url').value.trim();
      const token = normalizeAccessToken(document.getElementById('transport-token').value);
      if (!baseUrl) {
        throw new Error('è¯·å…ˆå¡«å†™ Core Transport çš„ Base URL');
      }
      return { baseUrl, token };
    }

    // æ³¨æ„ï¼šåº•å±‚ç»„ä»¶ï¼ˆcreateHttpClientã€DbClientï¼‰å·²ä» SDK ä¸­ç§»é™¤
    // ä»¥ä¸‹åº•å±‚æµ‹è¯•åŠŸèƒ½å·²ç¦ç”¨ï¼Œä»…ä¿ç•™ä¸šåŠ¡ API æµ‹è¯•

    // ============================================
    // 1. Core Transport æµ‹è¯•ï¼ˆå·²ç¦ç”¨ï¼‰
    // ============================================
    document.getElementById('test-transport').addEventListener('click', async () => {
      log('transport-output', 'âš ï¸ åº•å±‚ç»„ä»¶æµ‹è¯•å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨ä¸šåŠ¡ API æµ‹è¯•', 'warning');
    });

    // ============================================
    // 2. PostgREST å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆå·²ç¦ç”¨ï¼‰
    // ============================================
    document.getElementById('test-postgrest').addEventListener('click', async () => {
      log('postgrest-output', 'âš ï¸ åº•å±‚ç»„ä»¶æµ‹è¯•å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨ä¸šåŠ¡ API æµ‹è¯•', 'warning');
    });

    // ============================================
    // 3. Runtime Conversations æµ‹è¯•
    // ============================================
    const convOperationSelect = document.getElementById('conv-operation');
    const convIdGroup = document.getElementById('conv-id-group');
    const convTitleGroup = document.getElementById('conv-title-group');

    convOperationSelect.addEventListener('change', (e) => {
      const op = e.target.value;
      // æ˜¾ç¤º conversation ID è¾“å…¥æ¡†ï¼ˆç”¨äº messages å’Œ delete æ“ä½œï¼‰
      convIdGroup.style.display = (op === 'messages' || op === 'delete') ? 'block' : 'none';
      // æ˜¾ç¤ºæ ‡é¢˜è¾“å…¥æ¡†ï¼ˆç”¨äº create æ“ä½œï¼‰
      convTitleGroup.style.display = op === 'create' ? 'block' : 'none';
    });

    document.getElementById('test-conversations').addEventListener('click', async () => {
      const userId = document.getElementById('conv-user-id').value;
      const operation = document.getElementById('conv-operation').value;
      const conversationId = document.getElementById('conv-conversation-id').value;
      const environment = document.getElementById('conv-environment').value;
      const accessTokenOverride = normalizeAccessToken(document.getElementById('conv-access-token').value);
      const appId = document.getElementById('conv-app-id').value.trim();
      const page = Math.max(1, Number(document.getElementById('conv-page').value || 1));
      const pageSize = Math.max(1, Number(document.getElementById('conv-page-size').value || 20));

      try {
        const { token: transportToken } = getTransportInputs();
        const accessToken = accessTokenOverride || transportToken;
        if (!accessToken) throw new Error('è¯·å¡«å†™ Access Tokenï¼ˆæˆ–åœ¨ Core Transport å¡«å†™ Auth Tokenï¼‰');

        // ç»Ÿä¸€ä½¿ç”¨å‡½æ•°å¼ API
        const { getConversationsList, getAppsWithConversationsList, getMessagesList, createConversation, deleteConversation } = initConversationSdk({
          environment,
          token: accessToken,
          fetch: proxyFetch,
        });

        if (operation === 'list') {
          const result = await getConversationsList({
            userId: userId?.trim() || undefined,
            appId: appId || undefined,
            orderBy: 'createdAt',
            order: 'desc',
            page,
            pageSize,
          });
          log(
            'conversations-output',
            `âœ… ä¼šè¯åˆ—è¡¨è·å–æˆåŠŸ: count=${result.data.length}\n` +
            `pagination:\n${safeStringify(result.pagination)}\n\n` +
            `data:\n${safeStringify(result.data).slice(0, 2000)}`,
            'success'
          );
          return;
        }

        if (operation === 'list-apps') {
          const result = await getAppsWithConversationsList({
            appId: appId || undefined,
            page,
            pageSize,
          });
          
          log(
            'conversations-output',
            `âœ… èšåˆæ•°æ®è·å–æˆåŠŸ\napps: ${result.apps?.length ?? 0}\nhasMore: ${result.hasMore}\n\n${safeStringify(result).slice(0, 3000)}`,
            'success'
          );
          return;
        }

        if (operation === 'messages') {
          if (!conversationId) {
            log('conversations-output', 'è¯·è¾“å…¥ Conversation ID', 'error');
            return;
          }
          
          const result = await getMessagesList(conversationId.trim(), {
            page,
            pageSize,
          });
          
          log(
            'conversations-output',
            `âœ… æ¶ˆæ¯åˆ—è¡¨è·å–æˆåŠŸ: count=${result.messages.length}\n` +
            `hasMore: ${result.hasMore}\n\n` +
            `${safeStringify(result)}`,
            'success'
          );
          return;
        }

        if (operation === 'create') {
          const title = document.getElementById('conv-title').value.trim();
          if (!title) {
            log('conversations-output', 'è¯·è¾“å…¥ä¼šè¯æ ‡é¢˜', 'error');
            return;
          }
          
          log('conversations-output', 'æ­£åœ¨åˆ›å»ºä¼šè¯...', 'info');
          
          const result = await createConversation({
            title,
            appId: appId || null,
            userId: userId?.trim() || '',
          });
          
          log(
            'conversations-output',
            `âœ… ä¼šè¯åˆ›å»ºæˆåŠŸ\n` +
            `conversation_id: ${result.conversation_id}\n` +
            `title: ${result.title}\n\n` +
            `${safeStringify(result)}`,
            'success'
          );
          return;
        }

        if (operation === 'delete') {
          if (!conversationId) {
            log('conversations-output', 'è¯·è¾“å…¥è¦åˆ é™¤çš„ Conversation ID', 'error');
            return;
          }
          
          log('conversations-output', `æ­£åœ¨åˆ é™¤ä¼šè¯ ${conversationId}...`, 'info');
          
          await deleteConversation(conversationId.trim());
          
          log(
            'conversations-output',
            `âœ… ä¼šè¯åˆ é™¤æˆåŠŸ\n` +
            `å·²åˆ é™¤ conversation_id: ${conversationId}`,
            'success'
          );
          return;
        }

        log('conversations-output', `æœªçŸ¥æ“ä½œ: ${operation}`, 'warning');

      } catch (error) {
        log('conversations-output', `é”™è¯¯: ${error.message}\n${error.stack || ''}`, 'error');
        console.error('å®Œæ•´é”™è¯¯ä¿¡æ¯:', error);
      }
    });

    // ä»…æµ‹è¯• authï¼šè·å– url_session_tokenï¼ˆä¸ä¾èµ– PostgREST è·¯ç”±æ˜¯å¦å¯ç”¨ï¼‰
    document.getElementById('test-url-session-token').addEventListener('click', async () => {
      const environment = document.getElementById('conv-environment').value;
      const accessTokenOverride = normalizeAccessToken(document.getElementById('conv-access-token').value);

      try {
        const { token: transportToken } = getTransportInputs();
        const accessToken = accessTokenOverride || transportToken;
        if (!accessToken) throw new Error('è¯·å¡«å†™ Access Tokenï¼ˆæˆ–åœ¨ Core Transport å¡«å†™ Auth Tokenï¼‰');

        const { getUrlSessionToken } = initConversationSdk({
          environment,
          token: accessToken,
          fetch: proxyFetch,
        });

        log('conversations-output', 'æ­£åœ¨è·å– URL Session Token...', 'info');
        const token = await getUrlSessionToken();
        log(
          'conversations-output',
          `âœ… è·å–æˆåŠŸ\nurlSessionToken: ${token}`,
          'success'
        );
      } catch (error) {
        log('conversations-output', `é”™è¯¯: ${error.message}`, 'error');
      }
    });

    // ============================================
    // 4. Chat WebSocket æµ‹è¯•
    // ============================================
    let chatClient = null;
    let chatUnsubscribe = null;
    let streamingElement = null;

    document.getElementById('chat-connect').addEventListener('click', async () => {
      const apiURL = document.getElementById('chat-api-url').value.trim();
      const baseURL = document.getElementById('chat-base-url').value;
      const token = document.getElementById('chat-token').value;
      const conversationId = document.getElementById('chat-conversation-id').value;
      const appId = document.getElementById('chat-app-id').value;

      if (!apiURL || !token || !conversationId || !appId) {
        showStatus('chat-status', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
        return;
      }

      try {
        showStatus('chat-status', 'æ­£åœ¨è¿æ¥ WebSocket...', 'info');

        // æ¸…ç†ä¸Šä¸€æ¬¡è®¢é˜…ï¼ˆå¦‚æœæœ‰ï¼‰
        if (chatUnsubscribe) {
          try { chatUnsubscribe(); } catch {}
          chatUnsubscribe = null;
        }
        streamingElement = null;

        chatClient = createChat({
          apiURL,
          baseURL: baseURL?.trim() || undefined,
          token: token.trim(),
          conversationId: conversationId.trim(),
          appId: appId.trim(),
        });

        await chatClient.connect();

        const messagesContainer = document.getElementById('chat-messages');
        chatUnsubscribe = chatClient.onMessage(
          (msg) => {
            // æ”¶åˆ°å®Œæ•´æ¶ˆæ¯ï¼ˆæµå¼ç»“æŸåä¼šè§¦å‘ï¼‰
            const el = createMessageElement(msg.role, msg.content);
            messagesContainer.insertBefore(el, messagesContainer.firstChild);
            messagesContainer.scrollTop = 0;
          },
          {
            onChunk: (chunk) => {
              // æµå¼å¢é‡å†…å®¹ï¼ˆç”¨äºæ‰“å­—æœºæ•ˆæœï¼‰
              if (!streamingElement) {
                streamingElement = createMessageElement('assistant', '', true);
                messagesContainer.insertBefore(streamingElement, messagesContainer.firstChild);
              }
              const contentDiv = streamingElement.querySelector('.message-content');
              contentDiv.textContent += chunk;
            },
            onComplete: () => {
              if (streamingElement) {
                streamingElement.className = 'message assistant';
                const roleDiv = streamingElement.querySelector('.message-role');
                roleDiv.textContent = 'Assistant';
                streamingElement = null;
              }
            },
            onError: (error) => {
              showStatus('chat-status', `âŒ æµå¼é”™è¯¯: ${error.message}`, 'error');
              if (streamingElement) {
                const contentDiv = streamingElement.querySelector('.message-content');
                contentDiv.textContent = `Stream error: ${error.message}`;
                streamingElement.className = 'message assistant';
                streamingElement = null;
              }
            },
            onSystem: (systemInfo) => {
              const sys = createMessageElement('info', `System: ${safeStringify(systemInfo)}`);
              messagesContainer.insertBefore(sys, messagesContainer.firstChild);
            }
          }
        );

        showStatus('chat-status', 'âœ… WebSocket å·²è¿æ¥', 'success');
        document.getElementById('chat-connect').disabled = true;
        document.getElementById('chat-disconnect').disabled = false;
        document.getElementById('chat-send').disabled = false;
        document.getElementById('chat-interrupt').disabled = false;

      } catch (error) {
        showStatus('chat-status', `âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        chatClient = null;
      }
    });

    document.getElementById('chat-disconnect').addEventListener('click', async () => {
      try {
        showStatus('chat-status', 'æ­£åœ¨æ–­å¼€è¿æ¥...', 'info');

        if (chatUnsubscribe) {
          try { chatUnsubscribe(); } catch {}
          chatUnsubscribe = null;
        }
        if (chatClient) {
          await chatClient.disconnect();
        }

        showStatus('chat-status', 'âœ… å·²æ–­å¼€è¿æ¥', 'success');
        document.getElementById('chat-connect').disabled = false;
        document.getElementById('chat-disconnect').disabled = true;
        document.getElementById('chat-send').disabled = true;
        document.getElementById('chat-interrupt').disabled = true;

        chatClient = null;
        streamingElement = null;

      } catch (error) {
        showStatus('chat-status', `âŒ æ–­å¼€å¤±è´¥: ${error.message}`, 'error');
      }
    });

    document.getElementById('chat-send').addEventListener('click', async () => {
      const content = document.getElementById('chat-message').value.trim();

      if (!content) {
        showStatus('chat-status', 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
        return;
      }

      if (!chatClient || !chatClient.isConnected()) {
        showStatus('chat-status', 'è¯·å…ˆè¿æ¥ WebSocket', 'error');
        return;
      }

      try {
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        const messagesContainer = document.getElementById('chat-messages');
        const userMsgDiv = createMessageElement('user', content);
        messagesContainer.insertBefore(userMsgDiv, messagesContainer.firstChild);

        await chatClient.sendMessage(content);

        showStatus('chat-status', 'âœ… æ¶ˆæ¯å·²å‘é€', 'success');
        document.getElementById('chat-message').value = '';

      } catch (error) {
        showStatus('chat-status', `âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
      }
    });

    document.getElementById('chat-interrupt').addEventListener('click', async () => {
      try {
        if (!chatClient) throw new Error('æœªè¿æ¥');
        await chatClient.interrupt();
        showStatus('chat-status', 'âœ… å·²ä¸­æ–­æ‰§è¡Œ', 'success');
      } catch (error) {
        showStatus('chat-status', `âŒ ä¸­æ–­å¤±è´¥: ${error.message}`, 'error');
      }
    });

    // é¡µé¢åŠ è½½å®Œæˆ
    console.log('SeaLink SDK æµ‹è¯•å¹³å°å·²åŠ è½½');
    console.log('å·²å¯ç”¨ importmapï¼Œæœ¬é¡µé¢ä¼šä»æœ¬åœ° dist å¯¼å…¥çœŸå® SDK');
    
    // SDK åŠ è½½å®Œæˆ
    console.log('âœ… SDK å·²åŠ è½½ï¼Œä½¿ç”¨å‡½æ•°å¼ API');
  </script>
</body>
</html>
